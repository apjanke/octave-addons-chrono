% Register chrono's QHelp with the doc browser

% Now, PKG_ADD is called during the pkg('install') step. But at this point,
% the package is not listed as installed yet, so we can't detect our metadata.
% And we shouldn't bother regestering help during the install step. So, as
% a hack, look up the call stack and see if we're being called inside
% pkg('install'), and if so abort the rest of package loading.

stack = dbstack;
for i = 1:numel (stack)
  frame = stack(i);
  if ismember (frame.name, {'install','uninstall'})
    % disp('PKG_ADD being called inside "pkg install"; skipping.');
    return;
  endif
endfor

% When PKG_ADD is called, the package directory is not on the path
% yet. And it's not passed any data indicating what package is being
% loaded. So we just have to look ourselves up in the package directory
% to find our paths.

my_pkg_name = 'chrono';
all_pkgs = pkg ('list');
my_pkg = [];
for i = 1:numel (all_pkgs)
  if isequal (all_pkgs{i}.name, my_pkg_name);
    my_pkg = all_pkgs{i};
    break;
  end
endfor

if isempty (my_pkg)
  error ('Unable to find pkg metadata for %s in pkg(''list'')', my_pkg_name);
endif

my_path = my_pkg.dir;
my_qhelp_file = fullfile (my_path, 'doc', [my_pkg_name '.qch']);
__octave_link_register_doc__ (my_qhelp_file);
